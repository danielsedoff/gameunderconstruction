<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta charset="utf-8" />
    <title>Game Under Construction</title>
    <style>
      body {
        background-color: #282828;
        color: #ffffff;
        font-size: 4em;
        font-family: monospace;
      }

      .tile {
        display: inline-block;
        max-width: 1.5em;
        text-align: center;
      }

      .o_1, .o_2, .o_3 {
        background-color: black;
      }

      .g_1, .g_2, .g_3 {
        background-color: darkgreen;
        color: whitesmoke;
      }

      .g_4, .g_5, .g_6 {
        background-color: aqua;
        color: magenta;
      }

      .g_7, .g_8, .g_9 {
        background-color: darkolivegreen;
        color: rebeccapurple;
      }

      .h_1, .h_2, .h_3 {
        background-color: pink;
        color: black;
      }

      .m_1, .m_2, .m_3 {
        background-color: red;
      }

      .win {
        background-color: gold;
        color: navy;
      }

      body {
        overscroll-behavior: contain;
        height: 100%;
      }

</style>
  </head>
  <body>
    <p id="herohealth"></p>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" id="bigtable">
    <script type="text/javascript">
      var bigtable = document.getElementById("bigtable");
      var fieldWidth = 9;
      var fieldHeight = 18;
      var level = 1;
      var maxLevel = 10;
      var heroHealth = 100;
      var heroPosition = [0, 0];

      enterLevel(level, fieldWidth, fieldHeight);

      // Basic Health stat.
      function displayHealth(){
        document.getElementById("herohealth").innerHTML = `health: ${heroHealth}%`;
      }

      // Draw obstacles.
      function drawRandomObstacle(length){
        [x, y] = randomGroundTile(fieldWidth, fieldHeight);
        dx = getRandomInt(-1, 1);
        dy = getRandomInt(-1, 1);
        if (dx == 0 && dy == 0) dy = 1;
        while(true){
          x += dx; y += dy;
          if(getTileAt(x, y) == undefined){
            break;
          }
          drawTileAt(`o_${level}`, x, y); 
        }
      }

      // Basic Hero Walking method
      function heroWalks(xChange, yChange) {
        displayHealth();
        let oldx = heroPosition[0];
        let oldy = heroPosition[1];
        let x = oldx + xChange;
        let y = oldy + yChange;

        // OUt of game field
        if (x < 0 || y < 0 || y >= fieldHeight || x >= fieldWidth) {
          return;
        }
        
        let newTileId = xyId(x, y);
        newTileContent = getTileAt(x, y);
        typeOfTile = newTileContent[0];

        if (typeOfTile == "s") {
          // Stairs, level up
          console.log("Walking down the stairs.");
          level++;

          //Win scenario
          if(level >= maxLevel){
            level = "win";
          }
          enterLevel(level, fieldWidth, fieldHeight);
          return;

        } else if (typeOfTile == "o") {
          // Obstacle
          console.log("Can't step on obstacles.");
          return;
          
        } else if (typeOfTile == "g") {
          // Ground. You can step on the ground.
          drawTileAt(newTileContent.join("_"), oldx, oldy);
          drawTileAt("h_1", x, y);

        } else if (typeOfTile == "m") {
          // Monster. Now a monster can not be killed.
          console.log("Stepped on a monster");
          [gtx, gty] = randomGroundTile(fieldWidth, fieldHeight);
          drawTileAt(getTileAt(gtx, gty).join("_"), oldx, oldy)
          heroPosition = [-2, -2];
          
          heroHealth -= 100;
          displayHealth();
          return;

        } else {
          console.log("Stepped on an unknown tile type.");
        }
        heroPosition = [x, y];
      }

      // Enable Arrow Keys. Global event.
      document.onkeydown = checkKey;
      function checkKey(e) {
        action = [];
        action[38] = () => {heroWalks(0, -1)}; /*UP*/
        action[40] = () => {heroWalks(0, 1)};  /*DN*/
        action[37] = () => {heroWalks(-1, 0)}; /*LT*/
        action[39] = () => {heroWalks(1, 0)};  /*RT*/
        e = e || window.event;
        if (action[e.keyCode] != undefined) {
          action[e.keyCode]();
        }
      }

      // Draw an empty table with divs whose ids are like x_2_y_5
      function drawEmptyTable(level, cols, rows) {
        var tileContent = "g_" + level;
        if(level == "win") {
          tileContent = "win";
        }
        var result = "";
        for (let y = 0; y < rows; y++) {
          result += "<tr>";
          for (let x = 0; x < cols; x++) {
            result += `<td><div class="tile, ${tileContent}" id="${xyId(x, y)}">${tileContent}</div></td>`;
          }
          result += "</tr>";
        }
        return result;
      }

      // Draw a tile with given content at x, y
      function drawTileAt(tileContent, x, y) {
        elem = document.getElementById(xyId(x, y));
        elem.innerHTML = elem.className = tileContent;
      }

      // Get tile content at x, y or [x, y] at once
      function getTileAt(x, y){
        result = document.getElementById(xyId(x, y));
        if (result == undefined) return undefined;
        return result.innerHTML.split("_");
      }

      // get tile element ID for given x, y
        function xyId(x, y) {
        return `x_${x}_y_${y}`;
      }


      // Enter a new level
      function enterLevel(level, fieldWidth, fieldHeight) {
        bigtable.innerHTML = drawEmptyTable(level, fieldWidth, fieldHeight);
        
        // Win scenario
        if(level == "win"){
          return;
        }

        // Hero position is global: visible outside function
        // TODO: Fix the bug where the Hero is INVISIBLE for the User
        heroPosition = randomGroundTile(fieldWidth, fieldHeight);
        heroWalks(0, 0);

        // Draw obstacles
        for (let i = 0; i < level / 2; i++){
          drawRandomObstacle(level * 2);
        }

        // Put monsters at random places.
        // TODO: The hero must be able to kill monsters.
        for(let i = 0; i < level; i++){
          let xy = randomGroundTile(fieldWidth, fieldHeight);
          drawTileAt(`m_${level}`, xy[0], xy[1]);
        }
        // Draw stairs.
        xy = randomGroundTile(fieldWidth, fieldHeight);
        drawTileAt(`s_${level}`, xy[0], xy[1]);

        // Check if the Stairs is Accessible.
        counter = 100;
        while(!isStairsAccessible() && counter > 0){
          counter--;
          enterLevel(level, fieldWidth, fieldHeight);
        }
        if (!isStairsAccessible()){
          document.body.innerHTML = "The Game has become too tough :(";
        }
      }

      // Get a random tile which has Ground as its content.
      function randomGroundTile(fieldWidth, fieldHeight){
        for(i = 0; i < fieldWidth * fieldHeight; i++){
          x = getRandomInt(0, fieldWidth - 1);
          y = getRandomInt(0, fieldHeight - 1);
          tileContent = getTileAt(x, y);
          typeOfTile = tileContent[0];
          if(typeOfTile == "g"){
            break;
          }
        }
        return [x, y];
      }

      // Get a random integer within given limits.
      function getRandomInt(min, max){
        min = Math.ceil(min);
        max = Math.ceil(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }


      let touchstartX = 0;
      let touchstartY = 0;
      let touchendX = 0;
      let touchendY = 0;
        
      function checkDirection() {
        
        dx = Math.abs(touchendX - touchstartX);
        dy = Math.abs(touchendY - touchstartY);

        // Distance too low
        if (Math.max(dx, dy) < 64) return;

        if (dx >= dy && touchendX < touchstartX) {heroWalks(-1, 0)}; /*LT*/
        if (dx < dy && touchendY < touchstartY) {heroWalks(0, -1)}; /*UP*/
        if (dx >= dy  && touchendX > touchstartX) {heroWalks(1, 0)};  /*RT*/
        if (dx < dy  && touchendY > touchstartY) {heroWalks(0, 1)};  /*DN*/

      }

      document.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX;
        touchstartY = e.changedTouches[0].screenY;
      })

      document.addEventListener('touchend', e => {
        touchendX = e.changedTouches[0].screenX;
        touchendY = e.changedTouches[0].screenY;
        checkDirection();
      })

      // Check whether the User will be able to get to the Stairs.
      function isStairsAccessible(){
        checkedCells = [];
        checkedCells.push(heroPosition);
        checkCell(heroPosition, checkedCells);
        return checkedCells.indexOf("success") > -1;
      }

      function checkCell(coord, checkedCells){
        checkedCells.push(coord.join(","));
        console.debug("checking cell " + coord);
        [x, y] = coord;
        [left,  right] = [ [x - 1, y], [x + 1, y] ];
        [upper, lower] = [ [x, y - 1], [x, y + 1] ];
        for(direction of [left, right, upper, lower]){
          if(checkedCells.indexOf(direction.join(",")) > -1) continue;
          tile = getTileAt(direction[0], direction[1]);
          console.debug(tile);
          if(tile == undefined) {
            continue;
          } 
          tileType = tile[0];
          if (tileType == "s"){
            checkedCells.push("success");
            return;
          } else if (tileType == "g"){
            checkCell(direction, checkedCells);
          }
        }
      }

    </script>
  </body>
</html>
