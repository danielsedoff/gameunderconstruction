<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta charset="utf-8" />
    <title>Game Under Construction</title>
    <style>
      body {
        background-color: #282828;
        color: #ffffff;
        font-size: 1.5em;
      }

      .tile {
        display: inline-block;
        width: 1.5em;
        max-width: 1.5em;
        height: 1.5em;
        max-height: 1.5em;
        text-align: center;
      }

      .o_1, .o_2, .o_3 {
        background-color: black;
      }

      .g_1, .g_2, .g_3 {
        background-color: darkgreen;
      }

      .h_1, .h_2, .h_3 {
        background-color: cyan;
        color: black;
      }

      .m_1, .m_2, .m_3 {
        background-color: red;
      }

      .win {
        background-color: gold;
        color: navy;
      }

</style>
  </head>
  <body>
    <table id="bigtable"></table>
    <script type="text/javascript">
      var bigtable = document.getElementById("bigtable");
      var fieldWidth = 9;
      var fieldHeight = 6;
      var level = 1;

      enterLevel(level, fieldWidth, fieldHeight);

      // Basic Hero Walking method
      function heroWalks(xChange, yChange) {
        let oldx = document.heroPosition[0];
        let oldy = document.heroPosition[1];
        let x = oldx + xChange;
        let y = oldy + yChange;

        if (x < 0 || y < 0 || y >= fieldHeight || x >= fieldWidth) {
          console.log("Out of game field.");
          return;
        }
        
        let newTileId = xyId(x, y);
        newTileContent = getTileAt(x, y);
        typeOfTile = newTileContent[0];

        if (typeOfTile == "s") {
          // Stairs, level up
          console.log("Walking down the stairs.");
          level++;

          //Win scenario
          if(level == 4){
            level = "win";
          }
          enterLevel(level, fieldWidth, fieldHeight);
          return;

        } else if (typeOfTile == "o") {
          // Obstacle/wall
          console.log("Can't step on obstacles.");
          return;
          
        } else if (typeOfTile == "g") {
          // Ground. You can step on the ground.
          drawTileAt(newTileContent.join("_"), oldx, oldy);
          drawTileAt("h_1", x, y);

        } else if (typeOfTile == "m") {
          // Monster. Now a monster can not be killed.
          // The level is now hardcoded to be 1.
          console.log("Stepped on a monster");
          drawTileAt(`g_${level}`, oldx, oldy)
          document.heroPosition = [-2, -2];
          return;

        } else {
          console.log("Stepped on an unknown tile type.");
        }
        document.heroPosition = [x, y];
      }

      // Enable Arrow Keys. Global event.
      document.onkeydown = checkKey;
      function checkKey(e) {
        e = e || window.event;

        if (e.keyCode == "38") {
          heroWalks(0, -1); // up arrow
        } else if (e.keyCode == "40") {
          heroWalks(0, 1); // down arrow
        } else if (e.keyCode == "37") {
          heroWalks(-1, 0); // left arrow
        } else if (e.keyCode == "39") {
          heroWalks(1, 0); // right arrow
        }
      }

      // Draw an empty table with divs whose ids are like x_2_y_5
      function drawEmptyTable(level, cols, rows) {
        var tileContent = "g_" + level;
        if(level == "win") {
          tileContent = "win";
        }
        var result = "";
        for (let y = 0; y < rows; y++) {
          result += "<tr>";
          for (let x = 0; x < cols; x++) {
            result += `<td><div class="tile, ${tileContent}" id="${xyId(x, y)}">${tileContent}</div></td>`;
          }
          result += "</tr>";
        }
        return result;
      }

      function drawTileAt(tileContent, x, y) {
        elem = document.getElementById(xyId(x, y));
        elem.innerHTML = elem.className = tileContent;
      }

      function getTileAt(x, y){
        return document.getElementById(xyId(x, y)).innerHTML.split("_");
      }

      function xyId(x, y) {
        // Compile tile ID with given X and Y coordinates.
        return `x_${x}_y_${y}`;
      }

      function enterLevel(level, fieldWidth, fieldHeight) {

        // Now it is at its most basic level.
        bigtable.innerHTML = drawEmptyTable(level, fieldWidth, fieldHeight);
        
        // Win scenario
        if(level == "win"){
          return;
        }

        // The hero position is global
        document.heroPosition = [1, 0];

        // The first step does not have a real old position, so:
        heroWalks(-1, 0);

        // Draw a level 1 obstacle. It is not walkable.
        drawTileAt(`o_${level}`, 3, 3);

        // Draw a level 1 monster. It can not be killed.
        drawTileAt(`m_${level}`, 4, 4);

        // Draw stairs.
        drawTileAt(`s_${level}`, 5, 5);

      }
    </script>
  </body>
</html>
